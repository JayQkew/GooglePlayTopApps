const categories = [
    'APPLICATION',
    'ANDROID_WEAR',
    'ART_AND_DESIGN',
    'AUTO_AND_VEHICLES',
    'BEAUTY',
    'BOOKS_AND_REFERENCE',
    'BUSINESS',
    'COMICS',
    'COMMUNICATION',
    'DATING',
    'EDUCATION',
    'ENTERTAINMENT',
    'EVENTS',
    'FINANCE',
    'FOOD_AND_DRINK',
    'HEALTH_AND_FITNESS',
    'HOUSE_AND_HOME',
    'LIBRARIES_AND_DEMO',
    'LIFESTYLE',
    'MAPS_AND_NAVIGATION',
    'MEDICAL',
    'MUSIC_AND_AUDIO',
    'NEWS_AND_MAGAZINES',
    'PARENTING',
    'PERSONALIZATION',
    'PHOTOGRAPHY',
    'PRODUCTIVITY',
    'SHOPPING',
    'SOCIAL',
    'SPORTS',
    'TOOLS',
    'TRAVEL_AND_LOCAL',
    'VIDEO_PLAYERS',
    'WATCH_FACE',
    'WEATHER',
    'GAME',
    'GAME_ACTION',
    'GAME_ADVENTURE',
    'GAME_ARCADE',
    'GAME_BOARD',
    'GAME_CARD',
    'GAME_CASINO',
    'GAME_CASUAL',
    'GAME_EDUCATIONAL',
    'GAME_MUSIC',
    'GAME_PUZZLE',
    'GAME_RACING',
    'GAME_ROLE_PLAYING',
    'GAME_SIMULATION',
    'GAME_SPORTS',
    'GAME_STRATEGY',
    'GAME_TRIVIA',
    'GAME_WORD',
    'FAMILY'
];

export const languages = [
    { code: "en", name: "English" },
    { code: "zh", name: "Chinese" },
    { code: "aa", name: "Afar" },
    { code: "ab", name: "Abkhazian" },
    { code: "af", name: "Afrikaans" },
    { code: "ak", name: "Akan" },
    { code: "sq", name: "Albanian" },
    { code: "am", name: "Amharic" },
    { code: "ar", name: "Arabic" },
    { code: "hy", name: "Armenian" },
    { code: "as", name: "Assamese" },
    { code: "az", name: "Azerbaijani" },
    { code: "bm", name: "Bambara" },
    { code: "eu", name: "Basque" },
    { code: "be", name: "Belarusian" },
    { code: "bn", name: "Bengali" },
    { code: "bs", name: "Bosnian" },
    { code: "bg", name: "Bulgarian" },
    { code: "my", name: "Burmese" },
    { code: "ca", name: "Catalan" },
    { code: "hr", name: "Croatian" },
    { code: "cs", name: "Czech" },
    { code: "da", name: "Danish" },
    { code: "nl", name: "Dutch" },
    { code: "eo", name: "Esperanto" },
    { code: "et", name: "Estonian" },
    { code: "fi", name: "Finnish" },
    { code: "fr", name: "French" },
    { code: "de", name: "German" },
    { code: "el", name: "Greek" },
    { code: "gu", name: "Gujarati" },
    { code: "he", name: "Hebrew" },
    { code: "hi", name: "Hindi" },
    { code: "hu", name: "Hungarian" },
    { code: "is", name: "Icelandic" },
    { code: "id", name: "Indonesian" },
    { code: "it", name: "Italian" },
    { code: "ja", name: "Japanese" },
    { code: "kn", name: "Kannada" },
    { code: "ko", name: "Korean" },
    { code: "lv", name: "Latvian" },
    { code: "lt", name: "Lithuanian" },
    { code: "mk", name: "Macedonian" },
    { code: "ml", name: "Malayalam" },
    { code: "ms", name: "Malay" },
    { code: "mr", name: "Marathi" },
    { code: "ne", name: "Nepali" },
    { code: "no", name: "Norwegian" },
    { code: "fa", name: "Persian" },
    { code: "pl", name: "Polish" },
    { code: "pt", name: "Portuguese" },
    { code: "ro", name: "Romanian" },
    { code: "ru", name: "Russian" },
    { code: "sr", name: "Serbian" },
    { code: "sk", name: "Slovak" },
    { code: "sl", name: "Slovenian" },
    { code: "es", name: "Spanish" },
    { code: "sv", name: "Swedish" },
    { code: "ta", name: "Tamil" },
    { code: "te", name: "Telugu" },
    { code: "th", name: "Thai" },
    { code: "tr", name: "Turkish" },
    { code: "uk", name: "Ukrainian" },
    { code: "ur", name: "Urdu" },
    { code: "vi", name: "Vietnamese" },
    { code: "cy", name: "Welsh" },
    { code: "xh", name: "Xhosa" },
    { code: "yi", name: "Yiddish" },
    { code: "zu", name: "Zulu" }
];

export const countries = [
    { code: "US", name: "United States" },
    { code: "GB", name: "United Kingdom" },
    { code: "CA", name: "Canada" },
    { code: "AU", name: "Australia" },
    { code: "IN", name: "India" },
    { code: "ZA", name: "South Africa" },
    { code: "FR", name: "France" },
    { code: "DE", name: "Germany" },
    { code: "IT", name: "Italy" },
    { code: "ES", name: "Spain" },
    { code: "BR", name: "Brazil" },
    { code: "MX", name: "Mexico" },
    { code: "RU", name: "Russia" },
    { code: "CN", name: "China" },
    { code: "JP", name: "Japan" },
    { code: "KR", name: "South Korea" },
    { code: "NL", name: "Netherlands" },
    { code: "SE", name: "Sweden" },
    { code: "NO", name: "Norway" },
    { code: "FI", name: "Finland" },
    { code: "DK", name: "Denmark" },
    { code: "IE", name: "Ireland" },
    { code: "NZ", name: "New Zealand" },
    { code: "SG", name: "Singapore" },
    { code: "MY", name: "Malaysia" },
    { code: "PH", name: "Philippines" },
    { code: "TH", name: "Thailand" },
    { code: "VN", name: "Vietnam" },
    { code: "ID", name: "Indonesia" },
    { code: "PK", name: "Pakistan" },
    { code: "SA", name: "Saudi Arabia" },
    { code: "AE", name: "United Arab Emirates" },
    { code: "EG", name: "Egypt" },
    { code: "NG", name: "Nigeria" },
    { code: "KE", name: "Kenya" },
    { code: "AR", name: "Argentina" },
    { code: "CL", name: "Chile" },
    { code: "CO", name: "Colombia" },
    { code: "PE", name: "Peru" },
    { code: "VE", name: "Venezuela" },
    { code: "CH", name: "Switzerland" },
    { code: "BE", name: "Belgium" },
    { code: "AT", name: "Austria" },
    { code: "PT", name: "Portugal" },
    { code: "GR", name: "Greece" },
    { code: "PL", name: "Poland" },
    { code: "CZ", name: "Czech Republic" },
    { code: "HU", name: "Hungary" },
    { code: "RO", name: "Romania" },
    { code: "BG", name: "Bulgaria" },
    { code: "TR", name: "Turkey" },
    { code: "UA", name: "Ukraine" },
    { code: "IL", name: "Israel" },
    { code: "HK", name: "Hong Kong" },
    { code: "TW", name: "Taiwan" },
    { code: "BD", name: "Bangladesh" },
    { code: "LK", name: "Sri Lanka" },
    { code: "NP", name: "Nepal" },
    { code: "MM", name: "Myanmar" }
];

document.getElementById('appForm').addEventListener('submit', function(event) {
    event.preventDefault();
    getExcelFile();
    getTopApps();
});

async function getExcelFile() {
    const formData = getFormData();

    try {
        const res = await fetch("/topAppsFile", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        if(!res.ok){
            throw new Error("Failed to download file");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        const downloadBtns = document.querySelectorAll('.download');

        if(downloadBtns.length > 0){
            downloadBtns[0].href = url;
            downloadBtns[0].download = `top_apps_${Date.now()}.xlsx`;
        } else{
            const btnContainer = document.getElementById('btn-container')
            const a = document.createElement('a');
            a.classList.add('download');
            a.href = url;
            a.download = `top_apps_${Date.now()}.xlsx`;
            a.textContent = 'Download'
            btnContainer.appendChild(a);
        }

        console.log("Download started successfully")
    } catch (error) {
        console.error("Error submitting form:", error);
        return null;
    }
}

async function getTopApps(){
    const formData = getFormData();

    try {
        const res = await fetch("/topApps", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData)
        });

        if(!res.ok){
            throw new Error("Failed to download file");
        }

        const topApps = await res.json();
        const specifiedData = topApps.map(app => {
            const timeStamp = new Date(app.updated);
            const appUpdate = new Intl.DateTimeFormat('en-US', {
                year: 'numeric',
                month: 'short',
                day: '2-digit'
            }).format(timeStamp);

            return{
                Title: app.title,
                AppID: app.appId,
                Updated: appUpdate,
                Version: app.version,
                Url: app.url
            }
        })

        generateTable(specifiedData);

    } catch (error) {
        console.error("Error submitting form:", error);
        return null;
    }

}

function generateTable(data) {
    const table = document.getElementById('top-apps-table');
    table.innerHTML = ''; // Clear existing table content

    const thead = document.createElement('thead');
    const hRow = document.createElement('tr');

    const cols = Object.keys(data[0]);

    cols.forEach((c, index) => {
        const th = document.createElement('th');
        th.textContent = c;
        th.setAttribute('data-column', c);
        th.setAttribute('data-order', 'desc'); // Default to descending order

        // Add ID to the "Updated" column header
        if (c === "Updated") {
            th.id = "update-header";
        }

        th.addEventListener('click', () => {
            sortTableByColumn(table, index, th);
        });

        hRow.appendChild(th);
    });

    thead.appendChild(hRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    data.forEach(row => {
        const tr = document.createElement('tr');
        cols.forEach(c => {
            const td = document.createElement('td');
            td.textContent = row[c];
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });

    table.appendChild(tbody);
}


function sortTableByColumn(table, columnIndex, header) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const order = header.getAttribute('data-order');
    const isAscending = order === 'asc';

    rows.sort((rowA, rowB) => {
        let cellA = rowA.children[columnIndex].textContent.trim();
        let cellB = rowB.children[columnIndex].textContent.trim();

        // Check if the column is a date
        const dateRegex = /\b\w{3}\s\d{2},\s\d{4}\b/; // Matches "Jan 01, 2024"
        if (dateRegex.test(cellA) && dateRegex.test(cellB)) {
            cellA = new Date(cellA);
            cellB = new Date(cellB);
        } else if (!isNaN(cellA) && !isNaN(cellB)) {
            // Convert numbers if the column contains numeric values
            cellA = parseFloat(cellA);
            cellB = parseFloat(cellB);
        }

        return isAscending ? cellA - cellB : cellB - cellA;
    });

    // Toggle order for next click
    header.setAttribute('data-order', isAscending ? 'desc' : 'asc');

    // Re-add sorted rows to tbody
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}


function createAllCategories(){
    const categorySelect = document.getElementById('category');

    categories.map(category => {
        const display = category.replace(/_/g, ' ')
            .toLowerCase()
            .replace(/\b\w/g, (match) => match.toUpperCase())
            .replace(/\bAnd\b/g, '&');

        const option = `
            <option value="${category}">${display}</option>
        `

        categorySelect.innerHTML += option;
    });
}

function createAllLanguages(){
    const langugeSelect = document.getElementById('language');

    languages.map(language => {
        const display = language.name;

        const option = `
            <option value="${language.code}">${display}</option>
        `

        langugeSelect.innerHTML += option;
    })
}

function createAllCountries(){
    const countrySelect = document.getElementById('country');

    countries.map(country => {
        const option = `
            <option value="${country.code}">${country.name}</option>
        `

        countrySelect.innerHTML += option;
    })    
}

function getFormData(){
    const category = document.getElementById('category').value;
    const collection = document.getElementById('collection').value;
    const numApps = document.getElementById('numapps').value;
    const language = document.getElementById('language').value;
    const country = document.getElementById('country').value;

    return { category, collection, numApps, language, country };
}

createAllCategories();
createAllLanguages();
createAllCountries();

// export default AppData;